<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Travel Planner Chatbot - Powered by Dify</title>
   <style>
       * {
           margin: 0;
           padding: 0;
           box-sizing: border-box;
       }

       body {
           font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
           background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
           min-height: 100vh;
           display: flex;
           align-items: center;
           justify-content: center;
           padding: 20px;
       }

       .chatbot-container {
           width: 100%;
           max-width: 450px;
           height: 600px;
           background: white;
           border-radius: 20px;
           box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
           display: flex;
           flex-direction: column;
           overflow: hidden;
       }

       .chatbot-header {
           background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
           color: white;
           padding: 20px;
           text-align: center;
       }

       .chatbot-header h1 {
           font-size: 24px;
           margin-bottom: 5px;
       }

       .server-status {
           background: #f0f9ff;
           color: #0369a1;
           padding: 8px 15px;
           font-size: 12px;
           text-align: center;
           border-bottom: 1px solid #e0e7ff;
       }

       .api-setup {
           background: #f8fafc;
           padding: 15px;
           border-bottom: 1px solid #e5e7eb;
           display: flex;
           gap: 10px;
           align-items: center;
       }

       .api-setup input {
           flex: 1;
           padding: 10px;
           border: 2px solid #e5e7eb;
           border-radius: 8px;
           font-size: 14px;
       }

       .api-setup button {
           background: #4f46e5;
           color: white;
           border: none;
           padding: 10px 15px;
           border-radius: 8px;
           cursor: pointer;
       }

       .chat-messages {
           flex: 1;
           padding: 20px;
           overflow-y: auto;
           background: #f8fafc;
           display: flex;
           flex-direction: column;
           gap: 15px;
       }

       .message {
           max-width: 80%;
           padding: 12px 16px;
           border-radius: 18px;
           font-size: 14px;
           line-height: 1.5;
       }

       .message.user {
           background: #4f46e5;
           color: white;
           align-self: flex-end;
       }

       .message.bot {
           background: white;
           color: #374151;
           align-self: flex-start;
           border: 1px solid #e5e7eb;
       }

       .message.system {
           background: #f3f4f6;
           color: #6b7280;
           align-self: center;
           font-style: italic;
           font-size: 12px;
       }

       .suggested-questions {
           margin-top: 10px;
           padding: 0 20px 15px 20px;
           display: none;
       }

       .suggested-questions h4 {
           color: #6b7280;
           font-size: 12px;
           margin-bottom: 8px;
           text-transform: uppercase;
           font-weight: 600;
       }

       .question-buttons {
           display: flex;
           flex-direction: column;
           gap: 6px;
       }

       .suggested-question {
           background: #f3f4f6;
           border: 1px solid #e5e7eb;
           padding: 8px 12px;
           border-radius: 12px;
           font-size: 13px;
           cursor: pointer;
           text-align: left;
           transition: all 0.2s;
           color: #374151;
       }

       .suggested-question:hover {
           background: #e5e7eb;
           transform: translateY(-1px);
       }

       .chat-input {
           padding: 20px;
           background: white;
           border-top: 1px solid #e5e7eb;
           display: flex;
           gap: 12px;
       }

       .chat-input textarea {
           flex: 1;
           padding: 12px 16px;
           border: 2px solid #e5e7eb;
           border-radius: 20px;
           resize: none;
           font-family: inherit;
           min-height: 44px;
       }

       .send-button {
           width: 44px;
           height: 44px;
           background: #4f46e5;
           color: white;
           border: none;
           border-radius: 50%;
           cursor: pointer;
           font-size: 18px;
       }

       .error-message {
           background: #fef2f2;
           color: #dc2626;
           padding: 12px;
           border-radius: 8px;
       }

       .success-message {
           background: #f0f9ff;
           color: #0369a1;
           padding: 12px;
           border-radius: 8px;
       }
   </style>
</head>
<body>
   <div class="chatbot-container">
       <div class="chatbot-header">
           <h1>üõ´ Travel Planner Chatbot</h1>
           <div style="font-size: 12px; opacity: 0.8;">Powered by Dify AI</div>
       </div>

       <div class="server-status" id="serverStatus">
           üîÑ Checking server connection...
       </div>

       <div class="api-setup">
           <input type="password" id="apiKey" placeholder="Enter Dify API key" value="">
           <button onclick="connect()">Connect</button>
       </div>

       <div class="chat-messages" id="messages"></div>

       <div class="suggested-questions" id="suggestedQuestions">
           <h4>üí° Suggested Questions</h4>
           <div class="question-buttons" id="questionButtons"></div>
       </div>

       <div class="chat-input">
           <textarea id="input" placeholder="Ask about travel destinations..." onkeydown="handleEnter(event)"></textarea>
           <button class="send-button" onclick="send()">‚û§</button>
       </div>
   </div>

   <script>
       let apiKey = '';
       let conversationId = '';

       // Check server status on page load
       window.onload = async function() {
           await checkServerStatus();
           document.getElementById('input').focus();
       };

       // Check if Flask server and Dify are running
       async function checkServerStatus() {
           try {
               const response = await fetch('/health');
               const status = await response.json();
               
               const statusElement = document.getElementById('serverStatus');
               if (status.dify_connection === 'connected') {
                   statusElement.innerHTML = '‚úÖ Flask server running ‚Ä¢ Dify connected';
                   statusElement.style.background = '#f0f9ff';
                   statusElement.style.color = '#0369a1';
               } else {
                   statusElement.innerHTML = '‚ö†Ô∏è Flask server running ‚Ä¢ Dify disconnected';
                   statusElement.style.background = '#fef3c7';
                   statusElement.style.color = '#92400e';
               }
           } catch (error) {
               const statusElement = document.getElementById('serverStatus');
               statusElement.innerHTML = '‚ùå Cannot connect to Flask server';
               statusElement.style.background = '#fef2f2';
               statusElement.style.color = '#dc2626';
           }
       }

       // Connect to Dify through Flask proxy
       async function connect() {
           apiKey = document.getElementById('apiKey').value.trim();
           if (!apiKey) {
               addMessage('error', 'Please enter your Dify API key');
               return;
           }

           try {
               addMessage('system', 'Connecting to Dify...');
               const response = await callAPI('Hello! I need help planning my travel.');
               
               // Remove connection message
               const systemMsg = document.querySelector('.message.system');
               if (systemMsg) systemMsg.remove();
               
               addMessage('bot', response.answer);
               
               if (response.message_id) {
                   await getSuggestedQuestions(response.message_id);
               }
               
               document.querySelector('.api-setup').style.display = 'none';
               addMessage('success', '‚úÖ Connected successfully to Dify!');
               
           } catch (error) {
               // Remove connection message
               const systemMsg = document.querySelector('.message.system');
               if (systemMsg) systemMsg.remove();
               
               addMessage('error', 'Connection failed: ' + error.message);
           }
       }

       // Send message through Flask proxy
       async function send() {
           const input = document.getElementById('input');
           const message = input.value.trim();
           if (!message || !apiKey) return;

           input.value = '';
           addMessage('user', message);
           hideSuggestedQuestions();

           try {
               const response = await callAPI(message);
               addMessage('bot', response.answer);
               
               if (response.message_id) {
                   await getSuggestedQuestions(response.message_id);
               }
               
           } catch (error) {
               addMessage('error', 'Error: ' + error.message);
           }
       }

       // Call Dify API through Flask proxy
       async function callAPI(message) {
           const response = await fetch('/api/chat', {
               method: 'POST',
               headers: {
                   'Authorization': `Bearer ${apiKey}`,
                   'Content-Type': 'application/json'
               },
               body: JSON.stringify({
                   inputs: {},
                   query: message,
                   response_mode: 'blocking',
                   conversation_id: conversationId,
                   user: 'user-123'
               })
           });

           if (!response.ok) {
               const errorData = await response.json().catch(() => ({}));
               throw new Error(errorData.message || `API Error ${response.status}`);
           }

           const data = await response.json();
           conversationId = data.conversation_id || conversationId;
           
           return data;
       }

       // Get suggested questions through Flask proxy
       async function getSuggestedQuestions(messageId) {
           if (!messageId) return;
           
           try {
               const response = await fetch(`/api/suggestions/${messageId}?user=user-123`, {
                   method: 'GET',
                   headers: {
                       'Authorization': `Bearer ${apiKey}`,
                       'Content-Type': 'application/json'
                   }
               });

               if (response.ok) {
                   const data = await response.json();
                   
                   if (data.suggested_questions && data.suggested_questions.length > 0) {
                       showSuggestedQuestions(data.suggested_questions);
                   } else if (data.data && Array.isArray(data.data)) {
                       showSuggestedQuestions(data.data);
                   }
               }
           } catch (error) {
               // Silently handle errors
           }
       }

       // Show suggested questions
       function showSuggestedQuestions(questions) {
           const container = document.getElementById('suggestedQuestions');
           const buttonsContainer = document.getElementById('questionButtons');
           
           buttonsContainer.innerHTML = '';
           
           questions.forEach(question => {
               const button = document.createElement('button');
               button.className = 'suggested-question';
               button.textContent = question;
               button.onclick = () => {
                   document.getElementById('input').value = question;
                   send();
               };
               buttonsContainer.appendChild(button);
           });
           
           container.style.display = 'block';
       }

       // Hide suggested questions
       function hideSuggestedQuestions() {
           document.getElementById('suggestedQuestions').style.display = 'none';
       }

       // Add message to chat
       function addMessage(type, content) {
           const div = document.createElement('div');
           div.className = type === 'error' ? 'error-message' : 
                          type === 'success' ? 'success-message' : 
                          type === 'system' ? 'message system' : 
                          `message ${type}`;
           div.textContent = content;
           document.getElementById('messages').appendChild(div);
           document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
       }

       // Handle Enter key
       function handleEnter(event) {
           if (event.key === 'Enter' && !event.shiftKey) {
               event.preventDefault();
               send();
           }
       }
   </script>
</body>
</html>
